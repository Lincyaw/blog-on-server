---
title: 页框回收
date: 2021-02-26 23:00:52
tags: 
	- linux
categories: 
	- 学习
---

参考资料：深入理解linux内核（中文第三版）

<!--more-->

Linux内核的页框回收算法*（page frame reclaiming algorithm，PFRA）*采取从用户态进程和内核高速缓存"窃取"页框的办法补充伙伴系统的空闲块列表。

实际上，在用完所有空闲内存之前，就必须执行页框回收算法。否则，内核很可能陷入一种内存请求的僵局中，并导致系统崩溃。也就是说，要释放一个页框，内核就必须把页框的数据写入磁盘，但是，为了完成这一操作，内核却要请求另一个页框（例如，为I/O 数据传送分配缓冲区首部）。因为不存在空闲页框，因此，不可能释放页框。

上述场景即体现了进程管理中的死锁避免，通过银行家算法等一系列操作避免死锁。

在回收页框的时候自然要考虑待回收的页框是什么类型的

| **页类型** | 说明                                                         | **回收操作**                 |
| ---------- | ------------------------------------------------------------ | ---------------------------- |
| 不可回收页 | 空闲页（包含在伙伴系统列表中）<br />保留页（PG_reserved标志置位）<br />内核动态分配页<br />进程**内核态**堆栈页<br />临时锁定页（PG_locked标志置位）<br />内存锁定页（在现行区中且VM_LOCKED标志置位） | 不允许也无需回收             |
| 可交换页   | **用户态**地址空间的匿名页<br />tmpfs文件系统的映射页（如IPC共享内存的页） | 将页的内容保存在交换区       |
| 可同步页   | 用户态地址空间的**映射页**<br />存有磁盘文件数据且在高速缓存中的页<br />块设备缓冲区页<br />某些磁盘高速缓存的页（如索引节点高速缓存） | 必要时，与磁盘映像同步这些页 |
| 可丢弃页   | 内存高速缓存中未使用页（如slab分配器高速缓存）<br />目录项高速缓存的未使用页 | 无需操作                     |

> 映射页：该页映射了一个文件的某个部分。比如，属于文件内存映射的用户态地址空间中所有页都是映射页，页高速缓存中的任何其他页也是映射页。映射页差不多都是可同步的∶为回收页框，内核必须检查页是否为脏，而且必要时将页的内容写到相应的磁盘文件中。

> 匿名页：指它属于一个进程的某匿名线性区（倒如，进程的用户态堆和堆栈中的所有页为匿名页）。为回收页框，内核必须将页中内容保存到一个专门的磁盘分区或磁盘文件，叫做"交换区"。因此，所有匿名页都是可交换的。

当PFRA必须回收属于某进程用户态地址空间的页框时，它必须考虑页框是否为共享的。共享页框属于多个用户态地址空间，而非共享页框属于单个用户态地址空间。注意，非共享页框可能属于几个轻量级进程，这些进程使用同一个内存描述符。

共享页框是怎么出现的？当进程创建子进程时，就建立了共享页框。正如第九章"写时复制"一节所述，子进程页表都从父进程中复制过来的，父子进程因此共享同一个页框。共享页框的另一个常见情形是∶一个或多个进程以共享内存映射的方式访问同一个文件。

# [反向映射](https://baike.baidu.com/item/%E5%8F%8D%E5%90%91%E6%98%A0%E5%B0%84/20835372?fr=aladdin)

为了释放上述的共享页框，内核需要快速定位指向同一页框的页表项，这个过程就叫做反向映射(reverse mapping)。

最简单的想法是给页描述符中添加一个指针，从而使一个页框与其对应的页表项连接起来。但是这样做使得系统开销很大。

## 面向对象的反向映射

对任何可回收的用户态页，内核保留系统中该页所在所有线性区（"对象"）的反向链接，每个线性区描述符存放一个指针指向一个内存描述符，而该内存描述符又包含一个指针指向一个页全局目录（Page Global Directory）。因此，这反向链接使得PFRA能够检索引用某页的所有页表项。因为线性区描述符比页描述符少，所以更新共享页的反向链接就比较省时间。我们来看看这一方法是如何实现的。

PFRA必须要确定待回收页是共享的或是非共享的，以及是映射页或是匿名页。为做到这一点，内核要查看页描述符的两个字段∶`_mapcount `和`mapping`。

> `_mapcount`字段存放引用页框的页表项数目。计数器的起始值为-1，这表示没有页表项引用该页框，如果值为0，就表示页是非共享的，而如果值大于0，则表示页是共享的。`page_mapcount`函数接收页描述符地址，返回值为`mapcount+1`（这样，如返回值为1，表明是某个进程的用户态地址空间中存放的一个非共享页）。

>  页描述符的`mapping`字段用于确定页是映射的或匿名的。说明如下:
>
> - 如果`mapping`字段空，则该页属于交换高速缓存
> - 如果`mapping`字段非空，且最低位是1，表示该页为匿名页，同时`mapping`字段中存放的是指向 `anon_vma`描述符的指针（参见下一节"匿名页的反向映射"）。
> - 如果`mapping`字段非空，且最低位是0，表示该页为映射页，同时`mapping`字段指向对应文件的`address_space`对象